# 要件ドキュメント

## 概要

kiro-lensプロジェクトにおいて、Fastifyのスキーマ機能とTypeBoxを活用した自動型生成システムを実装します。バックエンドのAPIスキーマ定義を単一の真実の源（Single Source of Truth）として、フロントエンドで使用する型定義を自動生成することで、型安全性の向上と人為的ミスの削減を実現します。2025年9月時点の最新技術（@fastify/type-provider-typebox v5.x、@sinclair/typebox、TypeScript 5.7.2）を活用した現代的なアプローチを採用します。

## 要件

### 要件1：TypeBoxベースのスキーマ定義システム

**ユーザーストーリー:** 開発者として、TypeBoxを使用してAPIスキーマを定義し、TypeScriptの型とJSON Schemaを同時に生成したい。

#### 受け入れ基準

1. WHEN APIエンドポイントを定義 THEN TypeBoxのType.Object等を使用してスキーマを定義する
2. WHEN スキーマを定義 THEN 自動的にTypeScript型とJSON Schemaが生成される
3. WHEN @fastify/type-provider-typebox v5.xを使用 THEN Fastify 5.xとの完全な互換性が保たれる
4. WHEN TypeScript 5.7.2の新機能を活用 THEN 最新の型推論とパフォーマンス向上が適用される

### 要件2：共有スキーマ定義システム

**ユーザーストーリー:** 開発者として、TypeBoxスキーマをsharedパッケージで定義し、バックエンドとフロントエンドで同じスキーマと型を使用したい。

#### 受け入れ基準

1. WHEN APIスキーマを定義 THEN packages/shared/src/schemas/に配置される
2. WHEN バックエンドでスキーマを使用 THEN sharedパッケージからインポートする
3. WHEN フロントエンドで型を使用 THEN Static<typeof Schema>でsharedのスキーマから型を推論する
4. WHEN スキーマを変更 THEN バックエンドとフロントエンドの両方で型エラーが検出される

### 要件3：既存APIの段階的移行

**ユーザーストーリー:** 開発者として、既存のFastifyルートを段階的にTypeBoxベースのスキーマに移行し、システムの安定性を保ちたい。

#### 受け入れ基準

1. WHEN 既存のfiles.tsルートを移行 THEN TypeBoxスキーマを使用した新しい定義に変更される
2. WHEN 移行中のAPI THEN 既存の機能が正常に動作し続ける
3. WHEN 新しいAPIエンドポイントを追加 THEN TypeBoxスキーマベースで定義される
4. WHEN 移行が完了 THEN 手動で管理していた型定義が削除される

### 要件4：型安全性の向上とコンパイル時エラー検出

**ユーザーストーリー:** 開発者として、APIの変更時にフロントエンドとバックエンドの型不整合をコンパイル時に検出し、実行時エラーを防止したい。

#### 受け入れ基準

1. WHEN APIスキーマを変更 THEN フロントエンドで型エラーが即座に表示される
2. WHEN 型に合わないリクエストを送信 THEN TypeScriptコンパイルエラーで事前に検出される
3. WHEN APIレスポンスの型が変更 THEN フロントエンドの処理箇所で型エラーが表示される
4. WHEN 新しいプロパティを追加 THEN フロントエンドで適切に型推論される

### 要件5：開発体験の向上とツール統合

**ユーザーストーリー:** 開発者として、共有スキーマシステムが開発ワークフローに自然に統合され、生産性を向上させたい。

#### 受け入れ基準

1. WHEN IDEで型定義を参照 THEN スキーマの詳細情報とドキュメントが表示される
2. WHEN 型定義を検索 THEN 元のスキーマ定義にジャンプできる
3. WHEN ホットリロード中 THEN スキーマ変更が即座に反映される
4. WHEN 新しい開発者がプロジェクトに参加 THEN スキーマベースの開発方法が明確に理解できる

### 要件6：パフォーマンスと保守性の最適化

**ユーザーストーリー:** 開発者として、TypeBoxスキーマシステムが高速で保守しやすく、プロジェクトの成長に対応できるようにしたい。

#### 受け入れ基準

1. WHEN TypeScriptコンパイルを実行 THEN 型推論が高速に完了する
2. WHEN スキーマファイルが増加 THEN コンパイル時間が適切に管理される
3. WHEN スキーマを確認 THEN 可読性の高い定義が維持される
4. WHEN TypeBoxの最新機能を使用 THEN パフォーマンス最適化が適用される

### 要件7：エラーハンドリングと検証の強化

**ユーザーストーリー:** 開発者として、TypeBoxの検証機能を活用して、実行時のデータ検証とエラーハンドリングを強化したい。

#### 受け入れ基準

1. WHEN 無効なリクエストを受信 THEN TypeBoxの検証でエラーが検出される
2. WHEN 検証エラーが発生 THEN 詳細なエラーメッセージが返される
3. WHEN レスポンスデータを検証 THEN スキーマに合わないデータが検出される
4. WHEN カスタム検証ルールを追加 THEN TypeBoxの拡張機能で実装される
